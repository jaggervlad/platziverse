{"version":3,"sources":["tests\\metric-tests.js"],"names":["test","require","sinon","proxyquire","metricFixtures","agentFixtures","config","logging","uuid","type","MetricStub","AgentStub","db","sandbox","uuidArgs","where","metricUuidArgs","attributes","group","include","model","raw","typeUuidArgs","limit","order","newMetric","agent_id","value","beforeEach","createSandbox","belongsTo","spy","hasMany","findOne","stub","withArgs","returns","Promise","resolve","byUuid","create","toJSON","findAll","all","findByAgentUuid","findByTypeAgentUuid","setupDatabase","afterEach","restore","t","truthy","Metric","serial","true","called","calledWith","metric","calledOnce","deepEqual"],"mappings":"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","sourceRoot":"C:\\Users\\USER\\Desktop\\platziverse\\platziverse-db","sourcesContent":["'use strict'\r\n\r\nconst test = require('ava')\r\nconst sinon = require('sinon')\r\nconst proxyquire = require('proxyquire')\r\n\r\nconst metricFixtures = require('./fixtures/metric')\r\nconst agentFixtures = require('./fixtures/agent')\r\n\r\nconst config = {\r\n  logging () {}\r\n}\r\n\r\nconst uuid = 'yyy-yyy-yyy'\r\nconst type = 'CPU'\r\nlet MetricStub = null\r\nlet AgentStub = null\r\nlet db = null\r\nlet sandbox = null\r\n\r\nconst uuidArgs = {\r\n  where: { uuid }\r\n}\r\n\r\nconst metricUuidArgs = {\r\n  attributes: ['type'],\r\n  group: ['type'],\r\n  include: [{\r\n    attributes: [],\r\n    model: AgentStub,\r\n    where: {\r\n      uuid\r\n    }\r\n  }],\r\n  raw: true\r\n}\r\n\r\nconst typeUuidArgs = {\r\n  attributes: ['id', 'type', 'value', 'created_at'],\r\n  where: {\r\n    type\r\n  },\r\n  limit: 20,\r\n  order: [['created_at', 'DESC']],\r\n  include: [{\r\n    attributes: [],\r\n    model: AgentStub,\r\n    where: {\r\n      uuid\r\n    }\r\n  }],\r\n  raw: true\r\n}\r\n\r\nconst newMetric = {\r\n  agent_id: 1,\r\n  type: 'CPU',\r\n  value: '18%'\r\n}\r\n\r\ntest.beforeEach(async () => {\r\n  sandbox = sinon.createSandbox()\r\n\r\n  MetricStub = {\r\n    belongsTo: sinon.spy()\r\n  }\r\n\r\n  AgentStub = {\r\n    hasMany: sinon.spy()\r\n  }\r\n\r\n  // Model create Stub\r\n  AgentStub.findOne = sandbox.stub()\r\n  AgentStub.findOne.withArgs(uuidArgs).returns(Promise.resolve(agentFixtures.byUuid(uuid)))\r\n\r\n  MetricStub.create = sandbox.stub()\r\n  MetricStub.create.withArgs(newMetric).returns(Promise.resolve({\r\n    toJSON () { return newMetric }\r\n  }))\r\n\r\n  metricUuidArgs.include[0].model = AgentStub\r\n  typeUuidArgs.include[0].model = AgentStub\r\n\r\n  // Model findAll Stub\r\n  MetricStub.findAll = sandbox.stub()\r\n  MetricStub.findAll.withArgs().returns(Promise.resolve(metricFixtures.all))\r\n  MetricStub.findAll.withArgs(metricUuidArgs).returns(Promise.resolve(metricFixtures.findByAgentUuid(uuid)))\r\n  MetricStub.findAll.withArgs(typeUuidArgs).returns(Promise.resolve(metricFixtures.findByTypeAgentUuid(type, uuid)))\r\n\r\n  const setupDatabase = proxyquire('../', {\r\n    './models/agent': () => AgentStub,\r\n    './models/metric': () => MetricStub\r\n  })\r\n\r\n  db = await setupDatabase(config)\r\n})\r\n\r\ntest.afterEach(() => {\r\n  sandbox && sandbox.restore()\r\n})\r\n\r\ntest('Metric', t => {\r\n  t.truthy(db.Metric, 'Metric service should exist')\r\n})\r\n\r\ntest.serial('Setup Metric', t => {\r\n  t.true(AgentStub.hasMany.called, 'AgentModel.hasMany was executed')\r\n  t.true(AgentStub.hasMany.calledWith(MetricStub), 'Argument should be the MetricModel')\r\n  t.true(MetricStub.belongsTo.called, 'MetricModel.belongsTo was executed')\r\n  t.true(MetricStub.belongsTo.calledWith(AgentStub), 'Argument should be the AgentModel')\r\n})\r\n\r\ntest.serial('Metric#findByAgentUuid', async t => {\r\n  const metric = await db.Metric.findByAgentUuid(uuid)\r\n\r\n  t.true(MetricStub.findAll.called, 'findAll should be called on model')\r\n  t.true(MetricStub.findAll.calledOnce, 'findAll should be called once')\r\n  t.true(MetricStub.findAll.calledWith(metricUuidArgs), 'findAll should be called with specified metricUuidArgs')\r\n\r\n  t.deepEqual(metric, metricFixtures.findByAgentUuid(uuid), 'should be the same')\r\n})\r\n\r\ntest.serial('Metric#findByTypeAgentUuid', async t => {\r\n  const metric = await db.Metric.findByTypeAgentUuid(type, uuid)\r\n\r\n  t.true(MetricStub.findAll.called, 'findAll should be called on model')\r\n  t.true(MetricStub.findAll.calledOnce, 'findAll should be called once')\r\n  t.true(MetricStub.findAll.calledWith(typeUuidArgs), 'findAll should be called with specified typeUuidArgs')\r\n\r\n  t.deepEqual(metric, metricFixtures.findByTypeAgentUuid(type, uuid), 'should be the same')\r\n})\r\n\r\ntest.serial('Metric#create', async t => {\r\n  const metric = await db.Metric.create(uuid, newMetric)\r\n\r\n  t.true(AgentStub.findOne.called, 'Agent findOne should be called on model')\r\n  t.true(AgentStub.findOne.calledOnce, 'Agent findOne should be called once')\r\n  t.true(AgentStub.findOne.calledWith(uuidArgs), 'findOne should be called with uuid args')\r\n\r\n  t.true(MetricStub.create.called, 'create should be called on model')\r\n  t.true(MetricStub.create.calledOnce, 'create should be called once')\r\n  t.true(MetricStub.create.calledWith(newMetric), 'create should be called with specified args')\r\n\r\n  t.deepEqual(metric, newMetric, 'agent should be the same')\r\n})\r\n"]}